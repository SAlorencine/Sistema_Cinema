<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerenciar Filmes (API REST)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">

    <h2>Gerenciamento de Filmes via API</h2>

    <div class="card p-4 mb-4">
        <form id="formFilme">
            <input type="hidden" id="idFilme"> <div class="mb-3">
                <label>Título:</label>
                <input type="text" id="titulo" class="form-control" required>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Gênero:</label>
                    <input type="text" id="genero" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label>Ano:</label>
                    <input type="number" id="ano" class="form-control" required>
                </div>
            </div>
            <div class="mb-3">
                <label>Sinopse:</label>
                <textarea id="sinopse" class="form-control"></textarea>
            </div>
            
            <button type="submit" class="btn btn-success" id="btnSalvar">Salvar</button>
            <button type="button" class="btn btn-secondary" onclick="limparForm()">Cancelar</button>
        </form>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Gênero</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="tabelaCorpo">
            </tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // URL da sua API criada no Passo 3
        const API_URL = "/api/v1/filmes";

        $(document).ready(function() {
            carregarFilmes();

            // SUBMIT DO FORMULÁRIO
            $("#formFilme").submit(function(event) {
                event.preventDefault();
                
                const filme = {
                    titulo: $("#titulo").val(),
                    genero: $("#genero").val(),
                    anoLancamento: $("#ano").val(), 
                    sinopse: $("#sinopse").val()
                };

                const id = $("#idFilme").val();

                if (id) {
                    // SE TEM ID, É EDIÇÃO (PUT)
                    $.ajax({
                        url: API_URL + "/" + id,
                        type: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify(filme),
                        success: function() {
                            alert("Filme atualizado!");
                            limparForm();
                            carregarFilmes();
                        }
                    });
                } else {
                    // SE NÃO TEM ID, É CRIAÇÃO (POST)
                    $.ajax({
                        url: API_URL,
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(filme),
                        success: function() {
                            alert("Filme cadastrado!");
                            limparForm();
                            carregarFilmes();
                        }
                    });
                }
            });
        });

        // FUNÇÃO GET (Listar)
        function carregarFilmes() {
    // URL da sua API REST
    const API_URL = "/api/v1/filmes"; 
    
    $.ajax({
        url: API_URL,
        type: "GET",
        // SOLUÇÃO: Adicione 'data' como um parâmetro na função de sucesso!
        success: function(data) { 
            $("#tabelaCorpo").empty(); 

            // Verifica se 'data' é um array antes de iterar
            if (Array.isArray(data)) { 
                $.each(data, function(i, filme) {
                    // Aqui você usa o 'data' que acabou de ser passado para a função
                    $("#tabelaCorpo").append(`
                        <tr>
                            <td>${filme.id}</td>
                            <td>${filme.titulo}</td>
                            <td>${filme.genero}</td>
                            <td>
                                <a href="detalhes.html?id=${filme.id}" class="btn btn-info btn-sm">Detalhes / Avaliar</a>
                                <button class="btn btn-warning btn-sm" onclick="prepararEdicao(${filme.id})">Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="deletarFilme(${filme.id})">Excluir</button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                 console.error("A API retornou dados, mas não é o formato de lista esperado:", data);
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
             console.error("Erro na requisição AJAX:", textStatus, errorThrown);
        }
    });
}

        // FUNÇÃO DELETE
        function deletarFilme(id) {
            if(confirm("Deseja realmente excluir?")) {
                $.ajax({
                    url: API_URL + "/" + id,
                    type: "DELETE",
                    success: function() {
                        carregarFilmes();
                    }
                });
            }
        }

        // PREPARAR EDIÇÃO (Busca dados e preenche form)
        function prepararEdicao(id) {
            $.ajax({
                url: API_URL + "/" + id,
                type: "GET",
                success: function(filme) {
                    $("#idFilme").val(filme.id);
                    $("#titulo").val(filme.titulo);
                    $("#genero").val(filme.genero);
                    $("#ano").val(filme.anoLancamento);
                    $("#sinopse").val(filme.sinopse);
                    $("#btnSalvar").text("Atualizar");
                }
            });
        }

        function limparForm() {
            $("#formFilme")[0].reset();
            $("#idFilme").val("");
            $("#btnSalvar").text("Salvar");
        }
    </script>
</body>
</html>